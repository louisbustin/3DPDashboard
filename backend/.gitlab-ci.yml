
build-backend:       # This job runs in the build stage, which runs first.
  image: python:3.8
  stage: build
  only:
    changes:
      - backend/**/*
  artifacts:
    untracked: true
    paths:
      - ./
    exclude:
      - "node_modules/**/*"
  before_script:
    - cd backend
    - pip3 install awscli --upgrade
    - pip3 install aws-sam-cli --upgrade
  script:
    - echo "Compiling the code..."
    - sam build
    - echo "Compile complete."

deploy-backend:
  stage: deploy
  image: python:3.8
  only:
    changes:
      - backend/**/*
    refs:
      - main
  dependencies:
    - "build-backend"
  before_script:
    - cd backend
    - pip3 install awscli --upgrade
    - pip3 install aws-sam-cli --upgrade
  script:
    - echo "Deploying container to s3"
    - sam deploy
    - echo "Deploy done for container"

